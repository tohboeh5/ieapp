# Storage & Data Model Requirements

category: Storage & Data Model
prefix: REQ-STO

requirements:
  - id: REQ-STO-001
    title: Storage Abstraction Using fsspec/OpenDAL
    description: |
      System MUST use fsspec (current) or OpenDAL (future Rust core) for all I/O operations.
      No direct filesystem calls allowed outside the storage abstraction layer.
    related_spec:
      - architecture/overview.md#module-responsibilities
      - stories/core.yaml#STORY-003
    priority: high
    status: implemented
    tests:
      pytest:
        - file: ieapp-cli/tests/test_workspace.py
          tests:
            - test_create_workspace_scaffolding
            - test_create_workspace_s3_unimplemented
        - file: ieapp-cli/tests/test_indexer.py
          tests:
            - test_indexer_run_once
      rust:
        - file: ieapp-core/tests/test_workspace.rs
          tests:
            - test_workspace_req_sto_002_create_workspace_scaffolding

  - id: REQ-STO-002
    title: Workspace Directory Structure
    description: |
      Workspace has the following structure:
      - meta.json, settings.json
      - classes/ (Iceberg-managed Class tables)
      - attachments/
    related_spec:
      - data-model/directory-structure.md
    priority: high
    status: implemented
    tests:
      pytest:
        - file: ieapp-cli/tests/test_workspace.py
          tests:
            - test_create_workspace_scaffolding
        - file: backend/tests/test_api.py
          tests:
            - test_create_workspace
      rust:
        - file: ieapp-core/tests/test_workspace.rs
          tests:
            - test_workspace_req_sto_002_create_workspace_scaffolding

  - id: REQ-STO-003
    title: File Permissions (chmod 600)
    description: |
      Apply chmod 600 to data directories to ensure privacy on local filesystem.
    related_spec:
      - security/overview.md
    priority: medium
    status: implemented
    tests:
      pytest:
        - file: ieapp-cli/tests/test_workspace.py
          tests:
            - test_create_workspace_scaffolding

  - id: REQ-STO-004
    title: Workspace Management via global.json
    description: |
      global.json maintains workspace registry and HMAC keys.
    related_spec:
      - data-model/overview.md#directory-structure
    priority: high
    status: implemented
    tests:
      pytest:
        - file: ieapp-cli/tests/test_workspace.py
          tests:
            - test_create_workspace_scaffolding
        - file: ieapp-cli/tests/test_integrity.py
          tests:
            - test_integrity_provider_for_workspace_success
            - test_integrity_provider_missing_hmac_key
      rust:
        - file: ieapp-core/tests/test_workspace.rs
          tests:
            - test_workspace_req_sto_002_create_workspace_scaffolding
            - test_workspace_req_sto_004_list_workspaces_from_global_json

  - id: REQ-STO-005
    title: Prevent Duplicate Workspace Creation
    description: |
      Returns 409 error when attempting to create a workspace with an existing ID.
    related_spec:
      - api/rest.md#create-workspace
    priority: medium
    status: implemented
    tests:
      pytest:
        - file: ieapp-cli/tests/test_workspace.py
          tests:
            - test_create_workspace_idempotency
        - file: backend/tests/test_api.py
          tests:
            - test_create_workspace_conflict
      rust:
        - file: ieapp-core/tests/test_workspace.rs
          tests:
            - test_workspace_req_sto_005_create_workspace_idempotency
      vitest:
        - file: frontend/src/lib/client.test.ts
          tests:
            - should throw error for duplicate workspace

  - id: REQ-STO-006
    title: Storage Connector Validation
    description: |
      Workspaces MUST accept storage connector updates and provide
      a validation endpoint before committing changes.
    related_spec:
      - stories/core.yaml#STORY-003
      - api/rest.md#test-connection
    priority: medium
    status: implemented
    tests:
      pytest:
        - file: backend/tests/test_api.py
          tests:
            - test_update_workspace_storage_connector
            - test_test_connection_endpoint

  - id: REQ-STO-007
    title: Backend IO Separation & Multi-fsspec Coverage
    description: |
      All filesystem interactions MUST remain inside ieapp-cli via fsspec/OpenDAL.
      Backend MUST operate correctly across multiple storage implementations
      (at least file and memory) using the shared library.
    related_spec:
      - architecture/overview.md#module-responsibilities
      - architecture/decisions.md#adr-006
    priority: high
    status: implemented
    tests:
      pytest:
        - file: backend/tests/test_api_memory.py
          tests:
            - test_create_workspace_memory
            - test_create_note_memory
            - test_update_note_and_search_memory
            - test_attachments_and_links_memory

  - id: REQ-STO-008
    title: Resilient global.json parsing
    description: |
      Listing workspaces MUST NOT fail when global.json is corrupt.
      The system MUST recover by restoring a default global.json and
      return an empty workspace list.
    related_spec:
      - data-model/file-schemas.yaml#global
    priority: high
    status: implemented
    tests:
      rust:
        - file: ieapp-core/tests/test_workspace.rs
          tests:
            - test_workspace_req_sto_008_list_workspaces_recovers_from_corrupt_global

  - id: REQ-STO-009
    title: Resilient workspace listing API
    description: |
      The backend MUST return a successful response for workspace listing
      even if storage roots are missing or core workspace listing fails.
      Local filesystem roots MUST be created automatically when absent.
    related_spec:
      - api/rest.md#list-workspaces
    priority: high
    status: implemented
    tests:
      pytest:
        - file: backend/tests/test_api.py
          tests:
            - test_list_workspaces_missing_root_creates_default
            - test_list_workspaces_handles_core_failure
