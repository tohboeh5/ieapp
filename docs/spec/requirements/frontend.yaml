# Frontend Requirements

category: Frontend UI
prefix: REQ-FE

requirements:
  - id: REQ-FE-001
    title: Space Selector
    description: |
      Select, switch, and create spaces.
    related_spec:
      - stories/core.yaml#STORY-003
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/SpaceSelector.test.tsx
          tests:
            - should render space options
            - should show loading state
            - should show error message
            - should call onSelect when space changes
            - should show create form when add button clicked
            - should call onCreate when form submitted
            - should hide create form when cancel clicked
        - file: frontend/src/lib/space-store.test.ts
          tests:
            - should create default space when none exist
            - should select existing default space
            - should restore persisted space selection
            - should create new space
            - should select space and persist choice
            - should not select non-existent space

  - id: REQ-FE-002
    title: Automatic Default Space Creation
    description: |
      Automatically create "default" space when none exist.
    related_spec:
      - architecture/overview.md
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/space-store.test.ts
          tests:
            - should create default space when none exist

  - id: REQ-FE-003
    title: Persist Space Selection
    description: |
      Save selected space to localStorage and maintain across sessions.
    related_spec:
      - architecture/overview.md
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/space-store.test.ts
          tests:
            - should restore persisted space selection
            - should select space and persist choice

  - id: REQ-FE-004
    title: Entry List Display
    description: |
      Display entry list with titles and properties.
    related_spec:
      - stories/core.yaml
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/EntryList.test.tsx
          tests:
            - should render empty state when no entries exist
            - should render list of entries with titles
            - should display extracted properties in entry cards
            - should handle entries with null or undefined properties gracefully
            - should call onSelect when a entry is clicked
            - should show loading state
            - should highlight selected entry
            - should render empty state when no entries exist
            - should render list of entries with titles
            - should call onSelect when a entry is clicked
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should load entries from API

  - id: REQ-FE-005
    title: Markdown Editor
    description: |
      Editor with Markdown editing, preview, and save functionality.
    related_spec:
      - stories/core.yaml#STORY-002
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/MarkdownEditor.test.tsx
          tests:
            - should render textarea with initial content
            - should call onChange when content is edited
            - should render markdown preview when preview mode is enabled
            - should be readonly when disabled
            - should show save indicator when dirty
            - should call onSave when save button is clicked
            - should support keyboard shortcut for save
            - should show conflict message when there is a conflict
            - should handle undefined content gracefully
            - should handle null content gracefully
            - should render preview with undefined content without crashing
            - should display placeholder when content is empty

  - id: REQ-FE-005a
    title: Editor Content Graceful Handling
    description: |
      Editor MUST handle undefined/null content gracefully, displaying an empty
      string instead of the literal text "undefined".

      New entry creation MUST display initial content immediately without
      waiting for resource load.

      Preview mode MUST NOT crash when content is undefined.
    related_spec:
      - architecture/frontend-backend-interface.md#error-handling-standards
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/MarkdownEditor.test.tsx
          tests:
            - should handle undefined content gracefully
            - should handle null content gracefully
            - should render preview with undefined content without crashing
            - should display placeholder when content is empty

  - id: REQ-FE-006
    title: Optimistic Updates
    description: |
      UI reflects changes immediately and syncs in background.
    related_spec:
      - architecture/decisions.md#adr-005
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should apply optimistic updates during update
            - should delete entry optimistically

  - id: REQ-FE-008
    title: Entry Selection and Highlight
    description: |
      Frontend MUST highlight the selected entry and load entry details.
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/EntryList.test.tsx
          tests:
            - should highlight selected entry
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should handle entry selection

  - id: REQ-FE-009
    title: Conflict Message Display
    description: |
      Frontend MUST notify the user on 409 Conflict errors.
    related_spec:
      - architecture/frontend-backend-interface.md#error-handling-standards
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/MarkdownEditor.test.tsx
          tests:
            - should show conflict message when there is a conflict

  - id: REQ-FE-010
    title: Editor Content Persistence During Save
    description: |
      Editor content MUST NOT be overwritten during or after save operation.
      Save operation MUST NOT trigger content reload from server.
    related_spec:
      - architecture/overview.md
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should not refetch after successful update
        - file: frontend/src/lib/store.test.ts
          tests:
            - legacy placeholder delegates to entry-store tests

  - id: REQ-FE-043
    title: Sample data error formatting
    description: |
      Frontend MUST display human-readable validation errors from the API
      without rendering placeholder strings like "[object Object]".
    related_spec:
      - architecture/frontend-backend-interface.md#error-handling-standards
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/client.test.ts
          tests:
            - should surface validation errors without object placeholders [REQ-FE-043]

  - id: REQ-FE-044
    title: Frontend multilingual dictionary and locale switching
    description: |
      Frontend UI labels MUST support dictionary-based localization loaded from
      the shared workspace dictionary, with at least English and Japanese.
      Users MUST be able to switch language from the theme/settings menu and
      the selected locale MUST persist in localStorage.
    related_spec:
      - architecture/frontend-backend-interface.md
      - tasks/tasks.md#phase-7-5-ui-polish-added
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/i18n.test.ts
          tests:
            - switches locale and translates labels
            - applies locale attributes on initialize
        - file: frontend/src/components/ThemeMenu.test.tsx
          tests:
            - shows language options in settings menu
            - switches locale when language changes

  - id: REQ-FE-036
    title: SQL Query Editor
    description: |
      The query UI MUST provide a Ugoite SQL editor with syntax highlighting,
      lint feedback, and completion for tables/fields.
      The editor MUST load shared SQL rules from shared/sql/ugoite-sql-rules.json
      and MUST render without CodeMirror extension errors.
    related_spec:
      - features/sql.md
      - stories/core.yaml#STORY-005
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/sql.test.ts
          tests:
            - should flag missing select clause
            - should accept valid select queries
            - should include entries table in schema
        - file: frontend/src/components/SqlQueryEditor.test.tsx
          tests:
            - should render without runtime errors

  - id: REQ-FE-041
    title: Theme Registry Validation
    description: |
      The frontend MUST externalize theme definitions into per-theme files and
      validate them at test time. Theme labels MUST be English-only.
    related_spec:
      - ui/README.md
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/themes/registry.test.ts
          tests:
            - defines a CSS file for each theme
            - uses English-only theme labels
            - maps neutral colors to theme tokens

  - id: REQ-FE-042
    title: Theme Coverage Enforcement
    description: |
      Theme-aware components MUST avoid raw Tailwind color utilities in favor
      of shared UI tokens, ensuring consistent theming across the UI.
    related_spec:
      - ui/README.md
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/themes/usage.test.ts
          tests:
            - "REQ-FE-042: avoids raw color utilities in themed components"

  - id: REQ-FE-011
    title: Editor Content Sync on Entry Switch Only
    description: |
      Editor content synchronization with server MUST only occur when:
      1) user explicitly selects a different entry
      2) user explicitly clicks refresh button
      3) space is changed

      Editor content MUST NOT be overwritten when:
      1) save operation completes
      2) selected entry resource is refetched
      3) entry list is reloaded

      Implementation requirements:
      - Track last-loaded entry id to detect entry switches vs resource updates.
      - Only update editor content when the entry id changes.
      - Reset the last-loaded entry id when space changes.
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should handle entry selection
            - should clear selection when deleting selected entry

  - id: REQ-FE-012
    title: Consecutive Save Support
    description: |
      Multiple consecutive saves on the same entry MUST work correctly.
      After each successful save, the local revision_id MUST be updated to
      enable the next save.

      Implementation requirements:
      - Store currentRevisionId locally and update after each successful save.
      - Use currentRevisionId as parent_revision_id for updates.
      - After entry creation, set currentRevisionId from API response.
      - Fall back to selected entry revision id only if currentRevisionId is unset.
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/lib/entry-store.test.ts
          tests:
            - should support consecutive saves with updated revision_id
      e2e:
        - file: e2e/entries.test.ts
          tests:
            - consecutive PUT should succeed with updated revision_id
            - PUT with stale revision_id should return 409 conflict

  - id: REQ-FE-013
    title: Save Must Actually Persist to Server
    description: |
      Save operation MUST send the actual edited content to the server.
      Server MUST persist the content to the filesystem.
      Reloading the page MUST show the previously saved content.

      Failure modes to prevent:
      - Early return due to missing revision id
      - editorContent returning stale/empty value
      - API request missing markdown field
      - backend returning success before write completes
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: high
    status: implemented
    tests:
      pytest:
        - file: backend/tests/test_api.py
          tests:
            - test_update_entry
      e2e:
        - file: e2e/entries.test.ts
          tests:
            - saved content should persist after reload (REQ-FE-010)

  - id: REQ-FE-014
    title: Search UI Component
    description: |
      Frontend MUST provide a search input that calls the /search endpoint
      and displays results with keyboard shortcuts (Cmd/Ctrl+K).
    related_spec:
      - stories/core.yaml#STORY-005
      - api/rest.md#keyword-search
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/SearchBar.test.tsx
          tests:
            - should render search input
            - should call onSearch when form is submitted

  - id: REQ-FE-015
    title: Asset Upload UI
    description: |
      Editor MUST provide file upload capability with drag-drop support and
      display attached files with type icons.
    related_spec:
      - stories/advanced.yaml#STORY-006
      - api/rest.md#assets
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/AssetUploader.test.tsx
          tests:
            - should render file input
            - should call onUpload when file is selected
            - should display uploading state
            - should display uploaded assets
            - should allow removing assets
            - should accept specific file types
            - should display error message on upload failure

  - id: REQ-FE-017
    title: Space Storage Configuration
    description: |
      Space settings MUST allow configuring storage backends (local, S3,
      remote) with connection validation before saving.
    related_spec:
      - api/rest.md#spaces
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/SpaceSettings.test.tsx
          tests:
            - should display space name
            - should display storage config
            - should call onSave when save button is clicked
            - should test connection when test button is clicked
            - should display success message after test connection
            - should display error message on test connection failure
            - should save storage config

  - id: REQ-FE-018
    title: Entry Forms View with Routing
    description: |
      Frontend MUST provide a high-performance entry form view using nested routing.
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/routes/spaces/[space_id]/entries/index.test.tsx
          tests:
            - selecting an entry form navigates correctly

  - id: REQ-FE-019
    title: Multi-column Sorting
    description: |
      FormTable MUST support sorting by any displayed field (Title,
      form-defined properties, Updated Date) with visual indicators.
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/FormTable.test.tsx
          tests:
            - "REQ-FE-019: sorts entries when clicking headers"

  - id: REQ-FE-020
    title: Hybrid Filtering
    description: |
      FormTable MUST provide both global keyword search and column-specific
      filtering to refine viewed records.
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/FormTable.test.tsx
          tests:
            - "REQ-FE-020: filters entries globally"

  - id: REQ-FE-021
    title: Context-aware CSV Export
    description: |
      Users MUST be able to export currently viewed records (respecting active
      filters and sort order) to a CSV file.
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/FormTable.test.tsx
          tests:
            - "REQ-FE-021: exports filtered data to CSV"

  - id: REQ-FE-030
    title: Inline Row Creation in Grid View
    description: |
      The grid view MUST provide a way to quickly add a new row (entry).
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/FormTable.test.tsx
          tests:
            - "REQ-FE-030: Add Row button creates a new entry"

  - id: REQ-FE-031
    title: Spreadsheet-like Grid Editing & Selection
    description: |
      Users MUST be able to select rectangular ranges of cells via dragging
      and edit cell values inline when edit mode is enabled.
    related_spec:
      - stories/advanced.yaml#STORY-009
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/FormTable.test.tsx
          tests:
            - "REQ-FE-031: Edit Mode toggle and inline edit"
            - "REQ-FE-031: keyboard copy shortcut"

  - id: REQ-FE-032
    title: Legacy Entries Route Redirect
    description: |
      The legacy /entries UI route MUST redirect users to /spaces.
    related_spec:
      - features/README.md
    priority: low
    status: implemented
    tests:
      vitest:
        - file: frontend/src/routes/entries/index.test.tsx
          tests:
            - "REQ-FE-032: legacy entries route redirects"

  - id: REQ-FE-033
    title: Entry Detail Navigation
    description: |
      Selecting an entry from the list MUST navigate to the entry detail view,
      correctly handling special characters in entry IDs.
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/routes/spaces/[space_id]/entries/index.test.tsx
          tests:
            - "REQ-FE-033: selecting an entry navigates with encoded id"
        - file: frontend/src/routes/spaces/[space_id]/forms/form-detail.test.tsx
          tests:
            - "REQ-FE-033: form detail navigation encodes entry id"
      e2e:
        - file: e2e/entries.test.ts
          tests:
            - "REQ-FE-033: Retrieve entry with special characters"
            - "REQ-FE-033: frontend entry detail route renders (not SolidJS Not Found)"
  - id: REQ-FE-034
    title: Entry Detail Loading State Management
    description: |
      When navigating between entries (from entry list, form table, or any navigation),
      the loading state MUST properly clear and display the entry content.
      The UI MUST NOT get stuck showing "Loading entry..." indefinitely.
      Rapid sequential navigation between multiple entries MUST work smoothly without
      requiring page reloads.
    rationale: |
      SolidJS createResource can maintain loading=true even after data loads/fails,
      especially during rapid navigation. The fix checks loading state in conjunction
      with data presence to avoid infinite loading screens.
    related_spec:
      - architecture/frontend-backend-interface.md#interaction-patterns
    priority: critical
    status: implemented
    tests:
      e2e:
        - file: e2e/entries.test.ts
          tests:
            - "REQ-FE-034: Multi-entry navigation should not get stuck in loading state"

  - id: REQ-FE-035
    title: Robust Entry Navigation and Recovery
    description: |
      Navigation to entry details must include fail-safes (e.g., timeouts) to prevent infinite loading states.
      The UI must successfully transition from loading to content or error state within 10 seconds.
      Users must be able to navigate away from a pending load without the UI becoming unresponsive.
    type: non-functional
    tests:
      e2e:
        - file: e2e/entries.test.ts
          tests:
            - "REQ-FE-035: Navigation timeout handling and recovery"

  - id: REQ-FE-040
    title: UI Spec YAML Registry Validation
    description: |
      Frontend tests MUST load all UI page YAML specs under docs/spec/ui/pages
      and validate page links, shared chrome, and component type registry.
    related_spec:
      - ui/README.md
    priority: medium
    status: implemented
    tests:
      vitest:
        - file: frontend/src/spec/ui-pages.test.ts
          tests:
            - "REQ-FE-040: loads UI page specs"
            - "REQ-FE-040: validates page links"
            - "REQ-FE-040: validates component types"
            - "REQ-FE-040: validates shared space chrome"
            - "REQ-FE-040: validates object/grid tabs"

  - id: REQ-FE-037
    title: Form-first Entry Creation UI
    description: |
      Creating a new entry MUST require selecting a Form. The create dialog
      MUST show the selected Form fields and generate the entry from the
      Form template with the correct frontmatter.
    related_spec:
      - data-model/overview.md#forms
      - stories/core.yaml#STORY-002
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/create-dialogs.test.tsx
          tests:
            - "REQ-FE-037: requires form selection before creating an entry"
            - "REQ-FE-037: blocks submission when required fields are empty"
            - "REQ-FE-037: pre-fills defaults for required fields"
        - file: frontend/src/components/ListPanel.test.tsx
          tests:
            - "REQ-FE-037: disables new entry when no forms exist"

  - id: REQ-FE-038
    title: Form Validation Feedback in Editor
    description: |
      When a save fails due to Form validation, the editor MUST surface the
      validation messages in a readable warning panel.
    related_spec:
      - stories/core.yaml#STORY-002
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/EntryDetailPane.test.tsx
          tests:
            - "REQ-FE-038: renders form validation warnings"

  - id: REQ-FE-039
    title: Reserved Metadata Column Guardrails
    description: |
      Form creation/editing UI MUST prevent users from defining fields that
      collide with reserved metadata column names (e.g., title, form, tags).
    related_spec:
      - data-model/overview.md#metadata-vs-content-columns
      - requirements/form.yaml#REQ-FORM-005
    priority: high
    status: implemented
    tests:
      vitest:
        - file: frontend/src/components/create-dialogs.test.tsx
          tests:
            - "REQ-FE-039: blocks reserved metadata column names"