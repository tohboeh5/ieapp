# Storage Schema Definitions
#
# Logical schema definitions for file-based resources and Iceberg tables.
# These schemas are used for validation and documentation.

version: "0.2"
updated: "2026-01"

classes:
  # Root level
  global:
    description: Workspace registry and system configuration
    path: global.json
    schema:
      type: object
      required: [version, workspaces, hmac_key_id, hmac_key]
      properties:
        version:
          type: integer
          description: Schema version
        default_storage:
          type: string
          description: Default storage URI (e.g., fs:///path)
        workspaces:
          type: array
          items:
            type: string
          description: List of workspace IDs
        hmac_key_id:
          type: string
          description: Current HMAC key identifier
        hmac_key:
          type: string
          description: Base64-encoded HMAC secret
        last_rotation:
          type: string
          format: date-time
          description: Last key rotation timestamp

  # Workspace level
  workspace_meta:
    description: Workspace metadata
    path: workspaces/{id}/meta.json
    schema:
      type: object
      required: [id, name, created_at]
      properties:
        id:
          type: string
          description: Unique workspace identifier
        name:
          type: string
          description: Human-readable workspace name
        created_at:
          type: string
          format: date-time
        storage_config:
          type: object
          properties:
            uri:
              type: string
              description: Storage URI (s3://, fs://, etc.)
            credentials_profile:
              type: string
        merge_strategy:
          type: string
          enum: [manual, last_write_wins]
        default_class:
          type: string
          description: Default class for new notes
        encryption:
          type: object
          properties:
            mode:
              type: string
              enum: [none, aes256]

  workspace_settings:
    description: Workspace settings
    path: workspaces/{id}/settings.json
    schema:
      type: object
      properties:
        default_class:
          type: string
        editor_theme:
          type: string
          enum: [light, dark]
        sync_interval_seconds:
          type: integer

  # Class definitions (Iceberg)
  class_definition:
    description: Class definition stored in Iceberg table metadata
    path: iceberg://classes/{name}
    schema:
      type: object
      required: [name, version, fields]
      properties:
        name:
          type: string
          description: Class name (Iceberg table namespace)
        version:
          type: integer
          description: Schema version for migrations
        allow_extra_attributes:
          type: string
          enum: [deny, allow_json, allow_columns]
          description: Policy for non-registered H2 sections
        fields:
          type: object
          additionalProperties:
            type: object
            required: [type]
            properties:
              type:
                type: string
                enum:
                  [string, markdown, number, double, float, integer, long, boolean, date, time, timestamp, timestamp_tz, timestamp_ns, timestamp_tz_ns, uuid, binary, list]
              required:
                type: boolean
              default:
                description: Default value for field
                type: [string, number, boolean, array, object, null]

  # Iceberg tables
  notes_table:
    description: Notes table for a Class (current head rows)
    path: iceberg://classes/{name}/notes
    schema:
      type: object
      required: [note_id, title, updated_at, fields]
      properties:
        note_id:
          type: string
        title:
          type: string
        class:
          type: string
          description: Associated class name (optional when implied by table)
        tags:
          type: array
          items:
            type: string
        links:
          type: array
          items:
            type: object
            required: [id, target, kind]
            properties:
              id:
                type: string
              target:
                type: string
                description: Target note ID
              kind:
                type: string
                enum: [related, parent, child, reference]
        canvas_position:
          type: object
          properties:
            x:
              type: number
            y:
              type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        fields:
          type: object
          description: Class-defined fields
        extra_attributes:
          type: object
          description: Extra attributes stored as JSON when allowed
        integrity:
          $ref: "#/classes/integrity"

  revisions_table:
    description: Revision history table for a Class
    path: iceberg://classes/{name}/revisions
    schema:
      type: object
      required: [revision_id, note_id, timestamp, fields]
      properties:
        revision_id:
          type: string
        note_id:
          type: string
        parent_revision_id:
          type: string
        timestamp:
          type: string
          format: date-time
        author:
          type: string
        fields:
          type: object
          description: Class-defined fields snapshot
        extra_attributes:
          type: object
          description: Extra attributes snapshot when allowed
        markdown_checksum:
          type: string
        integrity:
          $ref: "#/classes/integrity"

  # Shared schemas
  integrity:
    description: Integrity metadata
    schema:
      type: object
      properties:
        checksum:
          type: string
          description: SHA-256 hash
        signature:
          type: string
          description: HMAC signature
