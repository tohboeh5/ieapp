# Storage Schema Definitions
#
# Logical schema definitions for file-based resources and Iceberg tables.
# These schemas are used for validation and documentation.

version: "0.2"
updated: "2026-01"

schemas:
  # Root level
  global:
    description: Space registry and system configuration
    path: global.json
    schema:
      type: object
      required: [version, spaces, hmac_key_id, hmac_key]
      properties:
        version:
          type: integer
          description: Schema version
        default_storage:
          type: string
          description: Default storage URI (e.g., fs:///path)
        spaces:
          type: array
          items:
            type: string
          description: List of space IDs
        hmac_key_id:
          type: string
          description: Current HMAC key identifier
        hmac_key:
          type: string
          description: Base64-encoded HMAC secret
        last_rotation:
          type: string
          format: date-time
          description: Last key rotation timestamp

  # Space level
  space_meta:
    description: Space metadata
    path: spaces/{id}/meta.json
    schema:
      type: object
      required: [id, name, created_at]
      properties:
        id:
          type: string
          description: Unique space identifier
        name:
          type: string
          description: Human-readable space name
        created_at:
          type: string
          format: date-time
        storage_config:
          type: object
          properties:
            uri:
              type: string
              description: Storage URI (s3://, fs://, etc.)
            credentials_profile:
              type: string
        merge_strategy:
          type: string
          enum: [manual, last_write_wins]
        default_form:
          type: string
          description: Default form for new entries
        encryption:
          type: object
          properties:
            mode:
              type: string
              enum: [none, aes256]

  space_settings:
    description: Space settings
    path: spaces/{id}/settings.json
    schema:
      type: object
      properties:
        default_form:
          type: string
        editor_theme:
          type: string
          enum: [light, dark]
        sync_interval_seconds:
          type: integer

  # Form definitions (Iceberg)
  form_definition:
    description: Form definition stored in Iceberg table metadata
    path: iceberg://forms/{name}
    schema:
      type: object
      required: [name, version, fields]
      properties:
        name:
          type: string
          description: Form name (Iceberg table namespace)
        version:
          type: integer
          description: Schema version for migrations
        allow_extra_attributes:
          type: string
          enum: [deny, allow_json, allow_columns]
          description: Policy for non-registered H2 sections
        fields:
          type: object
          additionalProperties:
            type: object
            required: [type]
            properties:
              type:
                type: string
                enum:
                  [string, markdown, number, double, float, integer, long, boolean, date, time, timestamp, timestamp_tz, timestamp_ns, timestamp_tz_ns, uuid, binary, list, object_list]
              required:
                type: boolean
              default:
                description: Default value for field
                type: [string, number, boolean, array, object, null]

  sql_variable:
    description: SQL variable definition stored in the SQL Form
    schema:
      type: object
      required: [type, name, description]
      properties:
        type:
          type: string
          description: Variable type (string, number, date, etc.)
        name:
          type: string
          description: Variable name used in SQL
        description:
          type: string
          description: Human-readable description

  sql_record:
    description: SQL record stored in the SQL Form
    schema:
      type: object
      required: [sql, variables]
      properties:
        sql:
          type: string
          description: SQL query text
        variables:
          type: array
          items:
            $ref: "#/schemas/sql_variable"

  # Iceberg tables
  entries_table:
    description: Entries table for a Form (current head rows)
    path: iceberg://forms/{name}/entries
    schema:
      type: object
      required: [entry_id, title, updated_at, fields]
      properties:
        entry_id:
          type: string
        title:
          type: string
        form:
          type: string
          description: Associated form name (optional when implied by table)
        tags:
          type: array
          items:
            type: string
        links:
          type: array
          items:
            type: object
            required: [id, target, kind]
            properties:
              id:
                type: string
              target:
                type: string
                description: Target entry ID
              kind:
                type: string
                enum: [related, parent, child, reference]
        canvas_position:
          type: object
          properties:
            x:
              type: number
            y:
              type: number
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        fields:
          type: object
          description: Form-defined fields
        extra_attributes:
          type: object
          description: Extra attributes stored as JSON when allowed
        integrity:
          $ref: "#/schemas/integrity"

  revisions_table:
    description: Revision history table for a Form
    path: iceberg://forms/{name}/revisions
    schema:
      type: object
      required: [revision_id, entry_id, timestamp, fields]
      properties:
        revision_id:
          type: string
        entry_id:
          type: string
        parent_revision_id:
          type: string
        timestamp:
          type: string
          format: date-time
        author:
          type: string
        fields:
          type: object
          description: Form-defined fields snapshot
        extra_attributes:
          type: object
          description: Extra attributes snapshot when allowed
        markdown_checksum:
          type: string
        integrity:
          $ref: "#/schemas/integrity"

  # Shared schemas
  integrity:
    description: Integrity metadata
    schema:
      type: object
      properties:
        checksum:
          type: string
          description: SHA-256 hash
        signature:
          type: string
          description: HMAC signature
