name: ScanCode

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  scancode:
    name: ScanCode Scan
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout source
        uses: actions/checkout@v5
        with:
          path: scancode-inputs

      - name: Prune non-source artifacts
        run: |
          rm -rf scancode-inputs/.git
          rm -rf scancode-inputs/**/.venv
          rm -rf scancode-inputs/**/__pycache__
          rm -rf scancode-inputs/**/.pytest_cache
          rm -rf scancode-inputs/**/.mypy_cache
          rm -rf scancode-inputs/**/node_modules
          rm -rf scancode-inputs/**/dist
          rm -rf scancode-inputs/**/build
          rm -rf scancode-inputs/backend/workspaces
          rm -rf scancode-inputs/ieapp-core/target

      - name: Run ScanCode pipelines
        uses: aboutcode-org/scancode-action@beta
        with:
          project-name: "ieapp"
          inputs-path: "scancode-inputs"
          pipelines: "scan_codebase,find_vulnerabilities"
          output-formats: "json xlsx spdx cyclonedx:1.5"
          check-compliance: true
          compliance-fail-level: "ERROR"
          compliance-fail-on-vulnerabilities: true
          python-version: "3.12"
        env:
          VULNERABLECODE_URL: "https://public.vulnerablecode.io/"