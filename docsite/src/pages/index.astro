---
import { promises as fs } from "node:fs";
import path from "node:path";
import BaseLayout from "../layouts/BaseLayout.astro";
import { homeCapabilityCards, homeHeroLinks, navSections } from "../lib/navigation";

const docsRoot = path.resolve(process.cwd(), "../docs");

const walkByExtensions = async (dir: string): Promise<{ markdown: number; yaml: number }> => {
  const items = await fs.readdir(dir, { withFileTypes: true });
  let markdown = 0;
  let yaml = 0;

  for (const item of items) {
    const fullPath = path.join(dir, item.name);
    if (item.isDirectory()) {
      const child = await walkByExtensions(fullPath);
      markdown += child.markdown;
      yaml += child.yaml;
      continue;
    }

    if (!item.isFile()) continue;
    if (item.name.endsWith(".md")) markdown += 1;
    if (item.name.endsWith(".yaml") || item.name.endsWith(".yml")) yaml += 1;
  }

  return { markdown, yaml };
};

const counts = await walkByExtensions(docsRoot);
---

<BaseLayout
  title="Ugoite Docsite"
  description="Repository-backed, human-readable docs portal for specs, APIs, requirements, and governance."
  showSidebar={false}
>
  <section class="doc-hero">
    <div class="doc-hero-grid">
      <div>
        <span class="doc-badge">Local-First / AI-Native</span>
        <h1 class="mt-4 text-4xl font-bold tracking-tight sm:text-5xl" data-l10n-key="home_title">
          Ship with confidence from one source of truth
        </h1>
        <p class="mt-4 max-w-2xl text-sm sm:text-base doc-muted" data-l10n-key="home_desc">
          Ugoite Docsite renders docs/ directly and organizes architecture, API, requirements, and governance into
          one readable map.
        </p>
        <div class="mt-6 flex flex-wrap gap-2 text-sm">
          {homeHeroLinks.map((link) => (
            <a href={link.href} class="doc-cta">{link.title}</a>
          ))}
        </div>
      </div>
      <div class="doc-visual">
        <div class="doc-visual-head">
          <span class="doc-badge">Doc Graph</span>
          <span class="text-xs doc-muted">Live from repository files</span>
        </div>
        <div class="doc-visual-grid">
          <article class="doc-visual-card">
            <p class="doc-visual-label">Specs</p>
            <p class="doc-visual-value">{counts.markdown}</p>
            <p class="text-xs doc-muted">Markdown pages</p>
          </article>
          <article class="doc-visual-card">
            <p class="doc-visual-label">Contracts</p>
            <p class="doc-visual-value">{counts.yaml}</p>
            <p class="text-xs doc-muted">YAML artifacts</p>
          </article>
          <article class="doc-visual-card">
            <p class="doc-visual-label">Domains</p>
            <p class="doc-visual-value">{navSections.length}</p>
            <p class="text-xs doc-muted">Knowledge lanes</p>
          </article>
          <article class="doc-visual-card">
            <p class="doc-visual-label">Priority</p>
            <p class="doc-visual-value">REQ-*</p>
            <p class="text-xs doc-muted">Traceability-first</p>
          </article>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-6 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
    {homeCapabilityCards.map((card) => (
      <article class="doc-card doc-capability-card">
        <p class="doc-card-tag">{card.tag}</p>
        <h2 class="mt-2 text-lg font-semibold">{card.title}</h2>
        <p class="mt-2 text-sm doc-muted">{card.summary}</p>
        <a href={card.href} class="mt-4 inline-flex items-center gap-1 text-sm font-semibold">
          Open
          <span aria-hidden="true">→</span>
        </a>
      </article>
    ))}
  </section>

  <section class="mt-6 grid gap-4 lg:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)]">
    <article class="doc-card">
      <h2 class="text-xl font-semibold">Knowledge Architecture</h2>
      <p class="mt-2 text-sm doc-muted">
        Navigate the same hierarchy as docs/spec/index.md with focused lanes by responsibility.
      </p>
      <div class="mt-4 grid gap-3 sm:grid-cols-2">
        {navSections.map((section) => (
          <a href={section.items[0]?.href ?? "/docs/spec/index"} class="doc-lane" aria-label={`Open ${section.title}`}>
            <p class="text-sm font-semibold">{section.title}</p>
            <p class="mt-1 text-xs doc-muted">{section.description}</p>
            <p class="mt-2 text-xs">{section.items.length} linked docs</p>
          </a>
        ))}
      </div>
    </article>

    <article class="doc-card">
      <h2 class="text-xl font-semibold">Quick Start</h2>
      <ul class="mt-3 space-y-2 text-sm">
        <li><a class="doc-inline-link" href="/docs/README">1. Read project overview</a></li>
        <li><a class="doc-inline-link" href="/docs/spec/architecture/overview">2. Check module boundaries</a></li>
        <li><a class="doc-inline-link" href="/docs/spec/api/rest">3. Review API contracts</a></li>
        <li><a class="doc-inline-link" href="/docs/spec/requirements/README">4. Verify requirement mappings</a></li>
        <li><a class="doc-inline-link" href="/docs/tasks/tasks">5. Pick active milestones</a></li>
      </ul>
    </article>
  </section>

  <section class="mt-6 grid gap-4 md:grid-cols-2">
    {navSections.map((section) => (
      <article class="doc-card">
        <h2 class="text-lg font-semibold">{section.title}</h2>
        <p class="mt-1 text-xs doc-muted">{section.description}</p>
        <ul class="mt-3 space-y-2 text-sm">
          {section.items.map((item) => (
            <li>
              <a href={item.href} class="doc-row-link">
                <span>{item.title}</span>
                <span aria-hidden="true">→</span>
              </a>
            </li>
          ))}
        </ul>
      </article>
    ))}
  </section>
</BaseLayout>
